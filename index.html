import React, { useState, useEffect, useRef } from 'react';

// NOTE: This file is designed to run in a controlled environment.
// If you export this to your own GitHub Page, you MUST set the API key 
// manually for it to work, replacing the empty string below.
const API_KEY = "AIzaSyBKyX1C2c1SXQqmIoE7sTH2IkVbyvPf8Lg"; 
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

// Define the persona for a coding and website assistant
const SYSTEM_PROMPT = `
You are a highly capable AI Coding Assistant for a developer's portfolio website. 
Your primary function is to:
1. Answer questions about the user's projects, skills, and portfolio content.
2. Generate requested code snippets (e.g., JavaScript, HTML, CSS) when asked.
3. Format all code clearly using markdown code blocks (e.g., \`\`\`javascript\ncode\n\`\`\`).
4. Be professional, concise, and helpful. Keep non-code responses under 100 words.
`;

/**
 * Utility function to handle API calls with exponential backoff for reliability.
 * @param {string} query - The user's query.
 * @returns {Promise<string>} The generated text response.
 */
async function fetchGeminiResponse(query) {
    const maxRetries = 5;
    const payload = {
        contents: [{ parts: [{ text: query }] }],
        systemInstruction: {
            parts: [{ text: SYSTEM_PROMPT }]
        }
    };

    for (let retries = 0; retries < maxRetries; retries++) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.status === 429 && retries < maxRetries - 1) {
                const delay = Math.pow(2, retries) * 1000 + Math.random() * 500;
                await new Promise(resolve => setTimeout(resolve, delay));
                continue; // Retry
            }

            if (!response.ok) {
                const errorBody = await response.text();
                console.error(`API Call Error (${response.status}):`, errorBody);
                throw new Error(`API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return text || "I received an empty response. Could you rephrase that?";

        } catch (error) {
            console.error("Error fetching Gemini response:", error);
            if (retries === maxRetries - 1) {
                return `An error occurred: ${error.message}. Please check the console.`;
            }
        }
    }
    return "Failed to get a response after multiple retries.";
}

/**
 * Component to render a single message, handling Markdown (especially code blocks).
 */
const MessageBubble = ({ text, sender }) => {
    // Regular expression to find Markdown code blocks (```language\ncode\n```)
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)\n```/g;
    
    // Split the text into parts based on code blocks
    const parts = [];
    let lastIndex = 0;
    let match;

    while ((match = codeBlockRegex.exec(text)) !== null) {
        // Push the text before the code block
        if (match.index > lastIndex) {
            parts.push({ type: 'text', content: text.substring(lastIndex, match.index) });
        }
        
        // Push the code block
        const language = match[1] || 'plaintext';
        const code = match[2].trim();
        parts.push({ type: 'code', language, content: code });

        lastIndex = match.index + match[0].length;
    }

    // Push the remaining text
    if (lastIndex < text.length) {
        parts.push({ type: 'text', content: text.substring(lastIndex) });
    }

    const isUser = sender === 'user';
    
    return (
        <div className={`flex ${isUser ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[85%] rounded-2xl shadow-lg p-3 transition duration-300 ${
                isUser 
                    ? 'bg-blue-600 text-white rounded-br-none' 
                    : 'bg-white text-gray-800 rounded-tl-none border border-gray-100'
            }`}>
                {parts.map((part, index) => {
                    if (part.type === 'code') {
                        return (
                            <div 
                                key={index} 
                                className="my-2 bg-gray-800 text-green-300 p-3 rounded-lg overflow-x-auto text-sm font-mono shadow-inner"
                                style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-all' }} 
                            >
                                <div className="text-xs text-gray-400 mb-1">{part.language.toUpperCase()}</div>
                                <pre>{part.content}</pre>
                            </div>
                        );
                    }
                    
                    // Simple text formatting (bold, newlines)
                    let content = part.content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>');
                    
                    return <span key={index} dangerouslySetInnerHTML={{ __html: content }} />;
                })}
            </div>
        </div>
    );
};

const App = () => {
    const [messages, setMessages] = useState([
        { 
            text: "Hello! I'm your advanced AI Coding Assistant. I can answer questions about projects, or generate HTML, CSS, and JavaScript for you. Try asking me for a 'simple responsive card component'.", 
            sender: 'ai' 
        }
    ]);
    const [input, setInput] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const chatEndRef = useRef(null);

    // Auto-scroll to the bottom when messages change
    useEffect(() => {
        chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages]);

    const handleSend = async (e) => {
        e.preventDefault();
        const query = input.trim();
        if (!query || isLoading) return;

        // 1. Add user message
        const newUserMessage = { text: query, sender: 'user' };
        setMessages(prev => [...prev, newUserMessage]);
        setInput('');
        setIsLoading(true);

        try {
            // 2. Fetch AI response
            const aiResponseText = await fetchGeminiResponse(query);
            
            // 3. Add AI response
            const newAiMessage = { text: aiResponseText, sender: 'ai' };
            setMessages(prev => [...prev, newAiMessage]);
        } catch (error) {
            console.error("Chat error:", error);
            setMessages(prev => [...prev, { text: "I hit an unexpected error while fetching the response.", sender: 'ai' }]);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="flex flex-col h-screen bg-gray-50 font-sans antialiased">
            {/* Header */}
            <header className="flex items-center justify-between p-4 bg-gray-900 text-white shadow-xl z-10">
                <h1 className="text-2xl font-extrabold tracking-tight flex items-center">
                    <svg className="w-6 h-6 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                    Code Navigator
                </h1>
                <span className="text-sm font-light text-gray-400">React + Gemini</span>
            </header>

            {/* Chat Area */}
            <main className="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-100 shadow-inner">
                {messages.map((msg, index) => (
                    <MessageBubble key={index} text={msg.text} sender={msg.sender} />
                ))}
                {isLoading && (
                    <div className="flex justify-start">
                        <div className="bg-white p-3 rounded-xl rounded-tl-none max-w-xs shadow-md animate-pulse">
                            <div className="flex space-x-2 items-center">
                                <span className="h-2 w-2 bg-gray-400 rounded-full animate-bounce delay-75"></span>
                                <span className="h-2 w-2 bg-gray-400 rounded-full animate-bounce delay-150"></span>
                                <span className="h-2 w-2 bg-gray-400 rounded-full animate-bounce delay-300"></span>
                            </div>
                        </div>
                    </div>
                )}
                <div ref={chatEndRef} />
            </main>

            {/* Input Form */}
            <footer className="p-4 bg-white border-t border-gray-200 shadow-2xl z-10">
                <form onSubmit={handleSend} className="flex space-x-3">
                    <input
                        type="text"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        placeholder={isLoading ? "Generating code..." : "Ask me for code or project details..."}
                        disabled={isLoading}
                        className="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-md disabled:bg-gray-100 disabled:text-gray-500"
                        aria-label="Chat input"
                    />
                    <button
                        type="submit"
                        disabled={isLoading || !input.trim()}
                        className="bg-blue-600 text-white w-14 h-14 rounded-xl font-semibold hover:bg-blue-700 transition duration-150 shadow-xl disabled:bg-gray-400 flex items-center justify-center transform hover:scale-105"
                    >
                        {isLoading ? (
                            <svg className="animate-spin w-6 h-6 text-white" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        ) : (
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                            </svg>
                        )}
                    </button>
                </form>
            </footer>
        </div>
    );
};

export default App;


